version: '{branch}.{build}'
branches:
  only:
  - develop

image: Visual Studio 2017

environment:
  PHP_SDK_BINARY_TOOLS_VER: php-sdk-2.1.1

  matrix:
    - ARCH: x86
      PHP_VER: 7.2
      VC_VER: vc15
    - ARCH: x64
      PHP_VER: 7.2
      VC_VER: vc15 
install:
- cmd: cinst wget
build_script:
- cmd: >-
    "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" %ARCH%

    wget https://github.com/OSTC/php-sdk-binary-tools/archive/%PHP_SDK_BINARY_TOOLS_VER%.zip --no-check-certificate -q -O php-sdk-binary-tools-%PHP_SDK_BINARY_TOOLS_VER%.zip

    7z x -y php-sdk-binary-tools-%PHP_SDK_BINARY_TOOLS_VER%.zip -oC:\projects

    move C:\projects\php-sdk-binary-tools-%PHP_SDK_BINARY_TOOLS_VER% C:\projects\php-sdk
    
    C:\projects\php-sdk\bin\phpsdk_setvars.bat

    git clone https://github.com/php/php-src C:\projects\php-src -b PHP-%PHP_VER% --depth=1

    mkdir C:\projects\php-src\ext\componere

    xcopy C:\projects\componere C:\projects\php-src\ext\componere /s /e /y /q

    phpsdk_deps -u -t %VC_VER% -b %PHP_VER% -a %ARCH% -f -d C:\projects\php-src\deps

    cd C:\projects\php-src

    buildconf.bat

    configure.bat --disable-all --enable-cli --enable-zts --enable-componere=shared --enable-opcache --with-prefix=C:\projects\componere\zts --with-php-build=deps --enable-ipv6

    nmake

    nmake install

    echo [PHP]                                  >  C:\projects\componere\zts\php.ini

    echo extension_dir ="ext"                   >> C:\projects\componere\zts\php.ini

    echo extension=php_componere.dll            >> C:\projects\componere\zts\php.ini

    echo zend_extension=php_opcache.dll         >> C:\projects\componere\zts\php.ini

    echo opcache.optimization_level=0x7FFEBFFF  >> C:\projects\componere\zts\php.ini

    C:\projects\componere\zts\php.exe -v

    C:\projects\componere\zts\php.exe -m

    nmake clean

    configure.bat --disable-all --enable-cli --disable-zts --enable-componere=shared --enable-opcache --with-prefix=C:\projects\componere\nts --with-php-build=deps --enable-ipv6

    nmake

    nmake install

    echo [PHP]                                  >  C:\projects\componere\nts\php.ini

    echo extension_dir ="ext"                   >> C:\projects\componere\nts\php.ini

    echo extension=php_componere.dll            >> C:\projects\componere\nts\php.ini

    echo zend_extension=php_opcache.dll         >> C:\projects\componere\nts\php.ini

    echo opcache.optimization_level=0x7FFEBFFF  >> C:\projects\componere\nts\php.ini

    C:\projects\componere\nts\php.exe -v

    C:\projects\componere\nts\php.exe -m
test_script:
- cmd: >-
    set REPORT_EXIT_STATUS=1

    C:\projects\componere\zts\php.exe /projects/php-src/run-tests.php -P -g FAIL,SKIP -d opcache.enable_cli=1 /projects/php-src/ext/componere -q --show-diff

    C:\projects\componere\nts\php.exe /projects/php-src/run-tests.php -P -g FAIL,SKIP -d opcache.enable_cli=1 /projects/php-src/ext/componere -q --show-diff

    C:\projects\componere\zts\php.exe /projects/php-src/run-tests.php -P -g FAIL,SKIP -d opcache.enable_cli=0 /projects/php-src/ext/componere -q --show-diff

    C:\projects\componere\nts\php.exe /projects/php-src/run-tests.php -P -g FAIL,SKIP -d opcache.enable_cli=0 /projects/php-src/ext/componere -q --show-diff
artifacts:
  - path: nts
    name: Componere-NTS-%PHP_VER%-%ARCH%-%APPVEYOR_REPO_COMMIT%
    type: zip
  - path: zts
    name: Componere-ZTS-%PHP_VER%-%ARCH%-%APPVEYOR_REPO_COMMIT%
    type: zip
